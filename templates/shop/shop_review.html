{% extends 'shop/shop_detail.html' %}
{% load shop_tags staticfiles %}

{% block shopcontent %}
    <section class="review uk-margin-medium-top">

        <div class="uk-container">
            <div class="shadow uk-padding-large">
                <article class="uk-comment">
                    <h4 class="uk-comment-title uk-margin-remove">
                        Автор
                        <div class="group-star uk-display-inline-block">
                            <span class="star"></span>
                            <span class="star"></span>
                            <span class="star"></span>
                            <span class="star"></span>
                        </div>
                    </h4>
                    <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                        <li><a href="#">22.09.17 12:09</a></li>
                    </ul>
                    <div class="uk-comment-body">
                        <p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor
                            invidunt
                            ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo
                            duo
                            dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum
                            dolor
                            sit amet.</p>
                    </div>
                    <hr class="uk-divider-icon">
                </article>

                <article class="uk-comment">
                    <h4 class="uk-comment-title uk-margin-remove">
                        Автор
                        <div class="group-star uk-display-inline-block">
                            <span class="star"></span>
                            <span class="star"></span>
                            <span class="star"></span>
                            <span class="star"></span>
                            <span class="star"></span>
                        </div>
                    </h4>
                    <ul class="uk-comment-meta uk-subnav uk-subnav-divider uk-margin-remove-top">
                        <li><a href="#">12 дней назад</a></li>
                    </ul>
                    <div class="uk-comment-body">
                        <p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor
                            invidunt
                            ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo
                            duo
                            dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum
                            dolor
                            sit amet.</p>
                    </div>
                    <hr class="uk-divider-icon">
                </article>

                <form class="uk-form-stacked uk-margin-medium-top">
                    <div class="uk-margin">
                        <legend class="uk-legend">Добавить отзыв</legend>
                        <select id="rating-review" class="uk-margin">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                        <div class="uk-form-controls">
                            <textarea class="uk-textarea" rows="10" placeholder="Ваш отзыв"></textarea>
                        </div>
                    </div>
                    <button class="uk-button uk-button-default">Отправить</button>
                </form>
            </div>


        </div>
    </section>

    <section class="reviews">
        <div class="bg-white" id="shop_review">
            {% include 'layout/shop_reviews.html' %}
        </div>
    </section>

    <section class="reviews edit">
        <div class="bg-white">
            <div class="item">
                <form id='review_form' action="{% url 'shops:add_review' slug=shop.slug %}" method="post">
                    {% csrf_token %}
                    {% if user.is_authenticated %}
                        <div class="name">

                            <h5>Добавить отзыв</h5>

                            <h4>

                                <div class="star-wrapper">
                                    <div class="star default">
                                        <i class="fa fa-star-o" aria-hidden="true"></i>
                                        <i class="fa fa-star-o" aria-hidden="true"></i>
                                        <i class="fa fa-star-o" aria-hidden="true"></i>
                                        <i class="fa fa-star-o" aria-hidden="true"></i>
                                        <i class="fa fa-star-o" aria-hidden="true"></i>
                                    </div>
                                    <div class="star active star-behaviour" data-save-stars="false"
                                         data-stars-count="0">
                                        <i class="fa fa-star" aria-hidden="true"></i>
                                        <i class="fa fa-star" aria-hidden="true"></i>
                                        <i class="fa fa-star" aria-hidden="true"></i>
                                        <i class="fa fa-star" aria-hidden="true"></i>
                                        <i class="fa fa-star" aria-hidden="true"></i>
                                    </div>
                                </div>

                            </h4>

                        </div>
                        <div class="description">

                            <div class="form-group">
                                <textarea name="text" id="prod-rev" cols="30" rows="10" class="form-control"></textarea>

                            </div>
                            <button type="submit">Отправить</button>
                        </div>
                    {% else %}
                        <div class="name">
                            <h5>Чтобы добавить отзыв вам необходимо авторизоваться</h5>
                        </div>
                    {% endif %}

                </form>
            </div>

        </div>
    </section>
{% endblock %}

{% block js %}
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/common.js' %}"></script>

    <script>
        var form = $('#review_form');
        $(form).unbind('submit').bind('submit', function (event) {
            var data = $(form).serialize();
            console.log(data);
            data += '&rating=' + $('.star-behaviour').getRating();
            event.preventDefault();
            console.log('Send data function is called!');
            $.ajax({
                method: 'POST',
                url: $(form).attr('action'),
                dataType: 'JSON',
                data: data,
                success: function (response) {
                    if (response.success) {
                        $.ajax({
                            method: 'POST',
                            dataType: 'HTML',
                            url: '{% url "shop_reviews" %}',
                            data: {'csrfmiddlewaretoken': '{{ csrf_token }}', 'shop': '{{ shop.slug }}'},
                            success: function (response) {
                                console.log(response);
                                $('#shop_review').html(response);
                            },
                            error: function () {
                                console.error('Can\'t send ajax to load all comments');
                            }
                        });
                        $('.star-behaviour').clearRating();
                        $('#prod-rev').val('');
                    } else if (response.url) {
                        document.location.href = response.url;
                    }
                }
            });
        });


    </script>
{% endblock %}
