{% extends 'base-1.html' %}
{% load widget_tweaks %}
{% load staticfiles %}
{% block content %}

    <section class="edit-shop-detail">
        <div class="container">
            <h3>Создание и редактирование магазина</h3>
            <div class="form-filter">
                <form class="form-inline" method="post" enctype="multipart/form-data" id="add-shop-form">
                    {% csrf_token %}
                    {{ form.errors }}
                    <div class="col-md-8">
                        <div class="form-group input col-md-6">
                            <label for="">Название магазина</label>
                            {% render_field form.title|attr:"type:text" placeholder="" %}
                        </div>

                        <div class="form-group input col-md-6">
                            <label for="">E-mail магазина:</label>
                            {% render_field form.email|attr:"type:email" placeholder="" %}
                        </div>


                        <div class="inlines">
                            {% for form in formset %}
                                <div class="form-group input col-md-6">
                                    <label for="">Телефон</label>
                                    {{ form.phone|attr:"class:form-control" }}
                                </div>

                                <div class="form-group input col-md-6">
                                    <label for="">Адрес магазина:</label>
                                    {{ form.address|attr:"class:form-control" }}
                                </div>


                                <div class="form-group select col-md-6" style="margin-top: 10px">
                                    <label for="">Расположение вашего магазина</label>
                                    {{ form.place|attr:"class:form-control" }}
                                </div>
                                <div class="clearfix"></div>

                                <div class="form-group col-md-6 btn-toggle-day">
                                    <a class="add btn btn-toggle-day-time">Указать время работы</a>
                                </div>

                                <div class="col-md-12 toggle-days" id="toggle-days-1">
                                    <i>Оставьте поле пустым если выходной день</i>
                                    <div class="form-group input col-md-6">
                                        <label for="">Понидельник</label>
                                        {{ form.monday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}

                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group input col-md-6">
                                        <label for="">Вторник</label>
                                        {{ form.tuesday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group input col-md-6">
                                        <label for="">Среда</label>
                                        {{ form.wednesday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group input col-md-6">
                                        <label for="">Четверг</label>
                                        {{ form.thursday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group input col-md-6">
                                        <label for="">Пятница</label>
                                        {{ form.friday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group input col-md-6">
                                        <label for="">Суббота</label>
                                        {{ form.saturday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                                    </div>
                                    <div class="clearfix"></div>
                                    <div class="form-group input col-md-6">
                                        <label for="">Воскресенье</label>
                                        {{ form.sunday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                                    </div>
                                </div>



                                <div class="form-group input col-md-12" style="margin-top: 10px; margin-bottom: 10px;">
                                    <label class="switch">

                                        {{ form.published|attr:"class:switch__input"|attr:"id:id_piblished"|attr:"checked:checked" }}
                                        <div class="switch__toggle">
                                            <div class="switch__handle"></div>
                                        </div>
                                    </label>
                                    <label>Опубликовать</label>
                                </div>

                                <div class="form-group input col-md-12" style="margin-top: 10px; margin-bottom: 20px;">
                                    <label class="switch">

                                        {{ form.DELETE|attr:"class:switch__input"|attr:"id:id_piblished" }}
                                        <div class="switch__toggle">
                                            <div class="switch__handle"></div>
                                        </div>
                                    </label>
                                    <label>Удалить</label>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn add set-marker-trigger" data-id="0">Поставить
                                        метку на карте
                                    </button>
                                </div>


                                <div class="form-group col-md-6">
                                    {{ form.longitude|attr:"class:form-control"|attr:"type:hidden" }}
                                </div>
                                <div class="form-group col-md-6">
                                    {{ form.latitude|attr:"class:form-control"|attr:"type:hidden" }}
                                </div>


                                {{ formset.management_form }}

                            {% endfor %}



                            <div class="form-group input col-md-12">
                                <label for="">Короткое описание магазина:</label>
                                {% render_field form.short_description|attr:"rows:6" placeholder="Введите до 300 символов" %}
                            </div>
                            <div class="form-group input col-md-12">
                                <label for="">О компании</label>

                                {% render_field form.description|attr:"rows:6" placeholder="Введите полное описание" %}
                            </div>


                        </div>


                    </div>
                    <div class="col-md-4 upload-image-magazin">
                        <label class="upload" for="id_images">
                            <i class="glyphicon glyphicon-plus-sign"></i>
                            <div class="add-photo">
                                Добавить<br>фотографии
                            </div>
                        </label>

                        <div class="info">
                            <span>Рекомендация для фото</span>
                            <p>Размер: 380x380 или больше</p>
                            <p>Фон: белый или прозрачный</p>
                            <br>
                            <span id="file-counter" style="color: red;"></span>
                        </div>
                        <div class="img-wrapper">
                            {% render_field form.logo|attr:"type:file"|attr:"style:display:none;"|attr:"id:id_images" %}
                            <img id="logo_view" src=""/><span class="remove-logo">X</span></div>
                    </div>

                    <div class="col-md-12" style="padding: 0; background-color: #fff;">
                        <div class="col-md-8">
                            <div class="cover" style="overflow: hidden; padding: 30px 0;">
                                <div class="inline-appended"></div>


                                <div class="form-group col-md-12" style="margin-top: 10px; margin-bottom: 10px">
                                    <p style="margin: 0;">Если у вас есть филиалы, добавьте их</p><br>

                                </div>
                                <div class="form-group btn-group-form col-md-12">
                                    <button type="button" id="add-new-contact" class="btn add">Добавить филиал</button>
                                    <button type="submit" class="btn add">Сохранить</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </form>
            </div>
        </div>
    </section>

    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
         id="set-marker-modal">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">Поставьте маркер на карте</div>
                <div class="modal-body">
                    <div id="custom-map" style="width: 100%; height: 500px;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" data-dismiss="modal" aria-label="Close" class="add btn">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block js %}

    {{ block.super }}
    <script src="{% static 'js/jquery.2.2.4.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDXEuBW9AIFcfHx1UHvceIvCz0JnRNjGyo&callback=initMap">
    </script>
    <script src="{% static 'js/previewLogos.js' %}"></script>

    <script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>
    <script type="text/html" id="contact-template">
        <div class="inline-__prefix__">
            {% with formset.empty_form as form %}

                <div class="form-group input col-md-6">

                    <label for="">Телефон</label>
                    {{ form.phone|attr:"class:form-control" }}
                </div>

                <div class="form-group input col-md-6">
                    <label for="">Адрес магазина:</label>
                    {{ form.address|attr:"class:form-control" }}
                </div>

                <div class="form-group select col-md-6" style="margin-top: 10px; margin-bottom: 20px;">
                    <label for="">Расположение вашего магазина</label>
                    {{ form.place|attr:"class:form-control" }}
                </div>
                <div class="clearfix"></div>
                <div class="form-group col-md-6 btn-toggle-day">
                    <a class="add btn btn-toggle-day-time">Указать время работы</a>
                </div>

                <div class="col-md-12 toggle-days" id="toggle-days-1">

                    <div class="form-group input col-md-6">
                        <label for="">Понидельник</label>
                        {{ form.monday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group input col-md-6">
                        <label for="">Вторник</label>
                        {{ form.tuesday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group input col-md-6">
                        <label for="">Среда</label>
                        {{ form.wednesday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}

                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group input col-md-6">
                        <label for="">Четверг</label>
                        {{ form.thursday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group input col-md-6">
                        <label for="">Пятница</label>
                        {{ form.friday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group input col-md-6">
                        <label for="">Суббота</label>
                        {{ form.saturday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                    </div>
                    <div class="clearfix"></div>
                    <div class="form-group input col-md-6">
                        <label for="">Воскресенье</label>
                        {{ form.sunday|attr:"class:form-control"|attr:"placeholder:с 9:00 до 18:00" }}
                    </div>


                </div>

                <div class="form-group input col-md-12" style="margin-top: 10px; margin-bottom: 10px;">
                    <label class="switch">
                        {{ form.published|attr:"class:switch__input"|attr:"id:id_piblished"|attr:"checked:checked" }}
                        <div class="switch__toggle">
                            <div class="switch__handle"></div>
                        </div>
                    </label>
                    <label>Опубликовать</label>
                </div>



                <div class="form-group input col-md-12" style="margin-top: 10px; margin-bottom: 20px;">
                    <label class="switch">

                        {{ form.DELETE|attr:"class:switch__input"|attr:"id:id_piblished" }}
                        <div class="switch__toggle">
                            <div class="switch__handle"></div>
                        </div>
                    </label>
                    <label>Удалить</label>
                </div>
                <div class="col-md-6">
                    <button type="button" class="add btn set-marker-trigger" data-id="__prefix__">Поставить метку на
                        карте
                    </button>
                </div>





                {{ form.longitude|attr:"class:form-control"|attr:"type:hidden" }}
                {{ form.latitude|attr:"class:form-control"|attr:"type:hidden" }}
            {% endwith %}
        </div>
    </script>
    <script>
        var formSetsCounter = 0;
        $(function () {
            $('#add-new-contact').click(function (ev) {
                ev.preventDefault();
                var count = parseInt($('#id_contacts_set-TOTAL_FORMS').attr('value'), 10);
                formSetsCounter = count;
                var tmplMarkup = $('#contact-template').html();
                var compiledTmpl = tmplMarkup.replace(/__prefix__/g, count)
                console.log(compiledTmpl);
                $('div.inline-appended').append(compiledTmpl);
                $('#id_contacts_set-TOTAL_FORMS').attr('value', count + 1);
                initSetMarkerButton();
            });
        });

    </script>
    <script>
        let map = null;
        let markers = [];
        let mapCenter = {lat: 42.864272, lng: 74.579775};
        let workingIndex = -1;

        function initMap() {
            map = new google.maps.Map(document.getElementById('custom-map'), {
                center: mapCenter,
                zoom: 15,
                mapTypeId: google.maps.MapTypeId.TERRAIN
            });

            map.addListener('click', function (event) {
                addMarker(event.latLng);
            });

            // Adds a marker at the center of the map.
        }

        function addMarker(_location) {
            let currId = -1;
            for (let i = 0; i < markers.length; ++i) {
                if (markers[i]['id'] === workingIndex) currId = i;
            }

            $('#id_contacts_set-' + workingIndex + '-longitude').val(_location['lng']);
            $('#id_contacts_set-' + workingIndex + '-latitude').val(_location['lat']);
            let marker = new google.maps.Marker({
                position: _location,
                input_id: workingIndex
            });
            if (markers.length > 0 && currId > -1)
                markers[currId]['data'].setPosition(_location);
            else
                marker.setMap(map);
            markers.push({
                'id': workingIndex,
                'data': marker
            });

            marker.addListener('click', function () {
                removeMarker(marker);
            });
        }

        function removeMarker(marker) {
            marker.setMap(null);
            markers.splice(markers.indexOf(marker.input_id), 1);
            $('#id_contacts_set-' + marker.input_id + '-longitude').val('');
            $('#id_contacts_set-' + marker.input_id + '-latitude').val('');
        }

        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        // Shows any markers currently in the array.
        function showMarkers() {
            setMapOnAll(map);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }

        function openMarkerModal(index) {
            workingIndex = index;
            $('#set-marker-modal').modal('show');
            setTimeout(function () {
                google.maps.event.trigger(map, "resize");
                map.setCenter(mapCenter);
            }, 2000);
        }

        function closeMarkerModal() {
            $('#set-marker-modal').modal('hide');
        }
    </script>

    <script>
        function initSetMarkerButton() {
            $('.set-marker-trigger').unbind('click').bind('click', function (e) {
                e.preventDefault();
                openMarkerModal(parseInt($(this).attr('data-id')));
            });
        }
        initSetMarkerButton();
        $('#add-new-contact').on('click', function (e) {
            console.log(formSetsCounter);
            openMarkerModal(formSetsCounter);

        });
    </script>
{% endblock %}
