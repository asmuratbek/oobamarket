{% extends 'base-1.html' %}
{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
{% endblock %}
{% load widget_tweaks %}
{% load staticfiles %}
{% block content %}
    <section class="edit-shop-detail">
        <div class="container">
            <h3>Редактирование магазина</h3>
            <div class="form-filter">
                <form class="form-inline" method="post" action="{% url 'shops:update' slug=object.slug %}"
                      enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="col-md-8">
                        <div class="form-group input col-md-6">
                            {% if not form.title.errors %}
                                <label for="">Название магазина{% else %}{{ form.title.errors }}</label>{% endif %}
                            {{ form.title|attr:"type:text" }}
                        </div>

                        <div class="form-group {% if form.email.errors %}has-error{% endif %} input col-md-6">
                            {% if not form.email.errors %}
                                <label for="">E-mail магазина:</label>{% else %}
                                <label for="">E-mail магазина:{{ form.email.errors }}</label>{% endif %}
                            {% render_field form.email|attr:"type:email" placeholder="" %}
                        </div>

                        <div class="inlines">

                            {% include 'shop/partials/shop_inline_form.html' %}

                            <div class="form-group input col-md-12">
                                <label for="">Короткое описание магазина:</label>
                                {% render_field form.short_description|attr:"rows:6" placeholder="Введите до 300 символов" %}
                            </div>
                            <div class="form-group input col-md-12">
                                <label for="">О компании</label>

                                {% render_field form.description|attr:"rows:6" placeholder="Введите полное описание" %}
                            </div>
                            <div class="inline-appended"></div>

{#                            <div class="form-group col-md-12" style="margin-top: 10px; margin-bottom: 40px">#}
{#                                <p>Если у вас есть филиалы, добавьте их</p><br>#}
{##}
{#                            </div>#}

                        </div>

                        <div class="form-group btn-group-form col-md-12">
{#                            <button type="button" id="add-new-contact" class="btn add">Добавить филиал</button>#}
                            <button type="submit" class="btn add">Сохранить</button>
                        </div>

                    </div>


                    <div class="col-md-4 upload-image-magazin" id="shop-update-form">
                        <div class="form-group input">
                            <label for="id_logo" class="upload">

                                <i class="glyphicon glyphicon-plus-sign"></i>
                                <div class="add-photo">
                                    Добавить<br>фотографии
                                </div>
                            </label>
                            <div class="info">
                                <span>Рекомендация для фото:</span>
                                <p>Размер: 380x380 или больше</p>
                                <p>Фон: белый или прозрачный</p>
                                <br>
                                <span id="file-counter" style="color: red;"></span>
                            </div>
                            <div class="img-upload">
                                {% render_field form.logo|attr:"type:file" %}
                            </div>

                        </div>
                        <div class="img-wrapper">
                            {% if object.logo %}
                                <img src="{{ object.logo.url }}" alt="" id="id_logo2">
                                <span class="remove-logo-update">X</span>
                            {% else %}
                                <img src="" alt="" id="id_logo2">
                            {% endif %}
                            <input type="hidden" id="slug" value="{{ object.get_slug }}"/>
                        </div>


                    </div>
                </form>
            </div>
        </div>
    </section>
{% endblock %}
{% block js %}
    <script src="{% static 'js/jquery.2.2.4.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <script src="{% static 'js/previewLogos.js' %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <script type="text/javascript">
        ymaps.ready(init);
        $.fn.hasAttr = function(name) {
           return this.attr(name) !== undefined;
        };
        var modal_button = $('.set-marker-trigger');
        checkPlaceValue();
        $(document).on('change', '#id_contacts_set-0-place', function () {
            console.log($(this).val());
           if ($(this).val() === "") {
               modal_button.show();
           }
           else{
               modal_button.hide();}
        });

        function checkPlaceValue() {
            if($('#id_contacts_set-0-place').val() === "")
                modal_button.show();
            else
                modal_button.hide();
        }
{#        var xCor, yCor;#}
{#        if(($("#id_contacts_set-0-longitude").val() === "") ||#}
{#            ($("#id_contacts_set-0-latitude").val() === "")){#}
{##}
{#        }#}
        $(".btn-toggle-day").click(function (e) {
            e.preventDefault();
            $(".toggle-days").slideToggle("100").attr('data-id');

        });


        function setCoordsPostion(lat, long) {
            $("#id_contacts_set-0-longitude").val(long);
            $("#id_contacts_set-0-latitude").val(lat);
        }

        function changeValue(key, data, flag) {
        var true_input = $('#true-inputs').find('input#id_contacts_set-0-' + key);
        var true_value = true_input.val().replace(/[^\d.]/g, '');
        if (flag === "from") {
            if ((true_input.val() !== "") && (true_value.length <= 4)) {
                true_input.val(data + true_input.val());
            }
            else {
                true_input.val("");
                true_input.val(data + " - ");
            }
        } else {
            if((true_input.val() !== "") && (true_value.length <= 4)) {
                true_input.val(true_input.val() + data);
            } else {
                true_input.val("");
                true_input.val(" - " + data);
            }
        }
    }

    var day_key;
     $('.from_time').on('change', function () {
        day_key = $(this).closest('.fake-input').attr('data-key');
        var that = $(this);
        changeValue(day_key, that.val(), "from");
        if(that.closest('.fake-input').hasAttr('data-first')){
            console.log("hey!");
            $(".from_time").not(that).each(function (i, item) {
                if(($(item).closest('.fake-input').attr('data-key') !== 'sunday') &&
                    ($(item).closest('.fake-input').find('input.checked_day').hasAttr('checked'))){
                    $(item).val(that.val());
                    var item_key = $(item).closest('.fake-input').attr('data-key');
                    changeValue(item_key, that.val(), "from")
                }
            });
        }
    });

    $('.to_time').on('change', function () {
        day_key = $(this).closest('.fake-input').attr('data-key');
        var that = $(this);
        changeValue(day_key, that.val(), "to");
        if(that.closest('.fake-input').hasAttr('data-first')){
            $(".to_time").not(that).each(function (i, item) {
                if(($(item).closest('.fake-input').attr('data-key') !== 'sunday') &&
                    ($(item).closest('.fake-input').find('input.checked_day').hasAttr('checked'))){
                    $(item).val(that.val());
                    var item_key = $(item).closest('.fake-input').attr('data-key');
                    changeValue(item_key, that.val(), "to")
                }
            });
        }
    });

    $('.checked_day').on('click', function () {
        let parent = $(this).closest('.fake-input');
        var parent_key = parent.attr('data-key');
        if($(this).hasAttr('checked')) {
            $(this).attr('checked', false);
            parent.find('input.from_time').attr("disabled", true)
                                            .val("");
            parent.find('input.to_time').attr("disabled", true)
                                            .val("");
            $('#true-inputs').find('input#id_contacts_set-0-' + parent_key).val("");
        } else {
            $(this).attr('checked', true);
            parent.find('input.from_time').attr("disabled", false)
                                            .val("");
            parent.find('input.to_time').attr("disabled", false)
                                        .val("");
        }
    });


        $('.fake-input').each(function (i, item) {
            var data_key = $(item).attr('data-key');
            var true_value = $('#true-inputs').find('input#id_contacts_set-0-' + data_key).val();
            $(item).find('input.from_time').val(true_value.split("-")[0]);
            $(item).find('input.to_time').val(true_value.split("-")[1]);
        });

        function init() {
        var myPlacemark,
        myMap = new ymaps.Map('yandex_map', {
            center: [42.8758,74.6179],
            zoom: 10,
            controls: ['zoomControl', 'typeSelector']
        });
        var searchControl = new ymaps.control.SearchControl({
            options: {
            float: 'left',
            floatIndex: 100,
            noPlacemark: true
     }
     });
        myMap.controls.add(searchControl);
        myMap.behaviors.disable('scrollZoom');
        myPlacemark = createPlacemark(["{{ latitude }}", "{{ longitude  }}"]);
        myMap.geoObjects.add(myPlacemark);
    // Слушаем клик на карте.
    myMap.events.add('click', function (e) {
        var coords = e.get('coords');
        setCoordsPostion(coords[0], coords[1]);
        // Если метка уже создана – просто передвигаем ее.
        if (myPlacemark) {
            myPlacemark.geometry.setCoordinates(coords);
        }
        // Если нет – создаем.
        else {
            myPlacemark = createPlacemark(coords);
            myMap.geoObjects.add(myPlacemark);
            // Слушаем событие окончания перетаскивания на метке.
            myPlacemark.events.add('dragend', function () {
                getAddress(myPlacemark.geometry.getCoordinates());
                setCoordsPostion(coords[0], coords[1]);
            });
        }
        getAddress(coords);
    });

    // Создание метки.
    function createPlacemark(coords) {
        return new ymaps.Placemark(coords, {
            iconCaption: 'поиск...'
        }, {
            preset: 'islands#violetDotIconWithCaption',
            draggable: true
        });
    }

    // Определяем адрес по координатам (обратное геокодирование).
    function getAddress(coords) {
        myPlacemark.properties.set('iconCaption', 'поиск...');
        ymaps.geocode(coords).then(function (res) {
            var firstGeoObject = res.geoObjects.get(0);

            myPlacemark.properties
                .set({
                    // Формируем строку с данными об объекте.
                    iconCaption: [
                        // Название населенного пункта или вышестоящее административно-территориальное образование.
                        firstGeoObject.getLocalities().length ? firstGeoObject.getLocalities() : firstGeoObject.getAdministrativeAreas(),
                        // Получаем путь до топонима, если метод вернул null, запрашиваем наименование здания.
                        firstGeoObject.getThoroughfare() || firstGeoObject.getPremise()
                    ].filter(Boolean).join(', '),
                    // В качестве контента балуна задаем строку с адресом объекта.
                    balloonContent: firstGeoObject.getAddressLine()
                });
        });
    }
}
{#    <script type="text/html" id="contact-template">#}
{#        <div class="inline-__prefix__">#}
{##}
{#                {% include 'shop/partials/additional-form.html' %}#}
{##}
{#        </div>#}
{#    </script>#}

     function Switch() {
        $('.switcher').on('change', function () {
            let that = $(this);
            let toggle = $('.toggle-days');
            let parent = that.closest(toggle);
            let weekDays = parent.find('.weekdays');
            if (that.attr('data-visible') === 'true') {
                $(weekDays).fadeOut('slow');
                that.attr('data-visible', 'false');
            } else {
                $(weekDays).fadeIn('slow');
                that.attr('data-visible', 'true');
            }
        });
        $('.switcher').each(function () {
            let that = $(this);
            let parent = that.closest('.toggle-days');
            let weekDays = parent.find('.weekdays');
            let checked = parent.find('input.switch__input');
            if (checked.attr('checked')) {
                that.attr('data-visible', 'false');
                $(weekDays).fadeOut('slow');
            } else {
                that.attr('data-visible', 'true');
                $(weekDays).fadeIn('slow');
            }

        });
    }
    Switch();
     </script>
    <script src="{% static 'js/picker.js' %}"></script>
<script src="{% static 'js/picker.time.js' %}"></script>
  <script>
    $('.timepicker').pickatime({
        format: 'HH:i'
    })
    </script>
{% endblock %}
