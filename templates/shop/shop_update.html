{% extends 'base-1.html' %}
{% block head %}
    {{ block.super }}
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/timepicker/1.3.5/jquery.timepicker.min.css">
{% endblock %}
{% load widget_tweaks %}
{% load staticfiles %}
{% block content %}
    <section class="creat-shop  uk-margin-medium-top">
        <div class="uk-container">
            <div class="shadow uk-padding-large">
                <form class="uk-grid" method="post" action="{% url 'shops:update' slug=object.slug %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <fieldset class="uk-fieldset uk-width-1-1@l">
                        <legend class="uk-legend uk-margin-medium-bottom"> Редактирование магазина</legend>
                        <div class="uk-grid uk-child-width-1-2@s" uk-grid>
                            <div class="">
                                <label class="uk-form-label ">Название магазина</label>
                                <div class="uk-form-controls ">
                                     {{ form.title|attr:"type:text"|attr:"class:uk-input" }}
                                </div>
                            </div>
                            <div>
                                <label class="uk-form-label">E-mail магазина:</label>
                                <div class="uk-form-controls">
                                    {% render_field form.email|attr:"type:email" class="uk-input" placeholder="" %}
                                </div>
                            </div>

                        </div>
                        {% include 'shop/partials/shop_inline_form.html' %}

                        <div class="uk-grid uk-child-width-1-1@l uk-margin-medium-top" uk-grid>
                            <div class="uk-form-controls">
                                <label class="uk-form-label">Короткое описание магазина:</label>
                                {% render_field form.short_description|attr:"rows:6" placeholder="Введите до 300 символов" class="uk-textarea" %}
                            </div>
                            <div class="uk-form-controls">
                                <label class="uk-form-label">О компании</label>
                                {% render_field form.description|attr:"rows:6" placeholder="Введите полное описание" class="uk-textarea" %}
                            </div>
                        </div>


                        <div class="seo">
                            <hr class="uk-divider-icon uk-margin-medium-top uk-margin-medium-bottom">
                            <button href="#toggle-animation"
                                    class="uk-button uk-button-default uk-width-1-3@l border-red" type="button"
                                    uk-toggle="target: #seo; animation: uk-animation-fade"
                                    title="Служит для продвижения ваших товаров в сети" uk-tooltip><span
                                    class="uk-margin-small-right" uk-icon="icon:  info"></span>Для Seo
                            </button>
                            <div id="seo"
                                 class="uk-card uk-card-default uk-card-body uk-margin-small uk-width-1-1@l "
                                 hidden>
                                <div class="uk-grid uk-child-width-1-1@l" uk-grid>
                                    <div class="">
                                        <label class="uk-form-label">Мета заголовок магазина:</label>
                                        <div class="uk-form-controls">
                                            {% render_field form.meta_title|attr:"type:text" placeholder="" class="uk-input" %}
                                        </div>
                                        <small>Введи до 45 символов название которое будет отображаться с посковиках.
                                            Для
                                            лучшего
                                            отображения введите ключевое слово товаров которые вы продаете в на сайте.
                                            Например
                                            если вы продаете кроссовки от найка и адидас. Правильный заголовок будет:
                                            "Купить
                                            кроссовки adidas и nike". Мы добавим в конце Бишкек и Ваше название
                                            магазина. Т.е.
                                            заголовок в последующем будет выглядеть так:"Купить кроссовки adidas и nike
                                            Бишкек -
                                            Кроссовки Центр."
                                        </small>
                                    </div>
                                    <div class="">
                                        <label class="uk-form-label">Мета описание магазина:</label>
                                        <div class="uk-form-controls">
                                            {% render_field form.meta_description|attr:"rows:6" placeholder="Введите до 220 символов" class="uk-input" %}
                                        </div>
                                        <small>В мета описании вы можете описать в кратце, какие товары вы продаете и
                                            чем
                                            занимаетесь.
                                            Лучше всего описание формируется, где включены несколько ключевых слов по
                                            которым вас
                                            будут искать. Чем лучше соответсвие,тем выше позиция.
                                        </small>
                                    </div>
                                    <div class="">
                                        <label class="uk-form-label">Мета ключевые слова магазина:</label>
                                        <div class="uk-form-controls">
                                            {% render_field form.meta_keywords|attr:"rows:6" placeholder="Введите до 10 ключевых слов" class="uk-input" %}
                                        </div>
                                        <small>В поле нужно вводить ключевые слова, например, если вы продаете
                                            кроссовки. То
                                            правильным
                                            набором ключевых слов будет: "Кроссовки, адидас, найк, бишкек, adidas, nike,
                                            купить и т.д."
                                        </small>
                                    </div>
                                    <div class="">
                                        <label class="uk-form-label">СЕО текс магазина:</label>
                                        <div class="uk-form-controls">
                                            {% render_field form.seo_text|attr:"rows:6" placeholder="Введите сео описание магазина" class="uk-textarea" %}
                                        </div>

                                        <small>Это поле не ограничено в заполнении. Но лучше всего чтобы он был не более
                                            500
                                            знаков.
                                            Сео описание влияет на продвижение вашего интернет магазина в поисковике,
                                            так что вам
                                            нужно самому написать текст. Мы настоятельно не рекомендуем копировать чужой
                                            текст,
                                            так как это не продвинет ваш магазин, а даже снизит его рейтинг в
                                            поисковике. Самым
                                            лучшим способом является составить текст из ключевых слов.
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>


                    <div class="uk-fieldset uk-width-1-1@l upload-shop-logo uk-margin-remove-top">
                        <hr class="uk-divider-icon uk-margin-medium-top uk-margin-medium-bottom">
                        <legend class="uk-legend uk-text-center uk-margin-small-bottom">Добавьте лого вашей фирмы
                        </legend>
                        <small class="uk-text-center uk-display-block uk-margin-medium-bottom uk-alert-danger">Размер
                            картинки должен быть 1:1
                        </small>
                        <div class="image-preview" {% if form.initial.logo %}style='background-image: url("{{ form.initial.logo.url }}");
                                background-size: cover;background-position: center center;'{% endif %}>
                            <label for="image-upload" class="image-label">Выбрать лого</label>
                            <input type="file" name="logo" id="image-upload"/>
                        </div>
                    </div>


                    <div class="uk-width-1-1@l uk-grid" uk-grid>
                        <div class=" uk-width-1-2@s uk-margin-medium-top">
                            <button type="submit" href="" class="uk-button uk-button-default border-red bg-red uk-width-1-2@l">
                                <span class="uk-margin-small-right" uk-icon="icon: check"> </span>Сохранить</button>
                        </div>
                        <div class=" uk-width-1-2@s uk-margin-medium-top uk-text-right@s">
                            <button type="submit" href="" class="uk-button uk-button-default uk-width-1-2@l" uk-toggle="target: #remove-shop-modal" >
                                <span class="uk-margin-small-right" uk-icon="icon: migtrash"> </span>Удалить</button>
                        </div>
                    </div>


                </form>
            </div>
        </div>
    </section>
    {% include 'layout/modal_shop_delete_confirm.html' %}
    <div id="modal-map" class=" uk-modal-container" uk-modal>
        <div class="modal-map uk-modal-dialog uk-modal-body">
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <h2 class="uk-modal-title uk-margin-medium-bottom">Укажите ваши координаты</h2>
            <div id="yandex_map" style="width: 100%; height: 500px;"></div>
        </div>
    </div>

{% endblock %}
{% block js %}
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/previewLogos.js' %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor-init.js" %}"></script>
    <script type="text/javascript" src="{% static "ckeditor/ckeditor/ckeditor.js" %}"></script>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <script type="text/javascript">
        ymaps.ready(init);
        $.fn.hasAttr = function (name) {
            return this.attr(name) !== undefined;
        };
        var modal_button = $('.set-marker-trigger');
        checkRoundtheClock();
        checkPlaceValue();
        $(document).on('change', '#id_contacts_set-0-place', function () {
            console.log($(this).val());
            if ($(this).val() === "") {
                modal_button.show();
            }
            else {
                modal_button.hide();
            }
        });

        function checkRoundtheClock() {
            if($('#id_contacts_set-0-round_the_clock').hasAttr('checked')){
                $('.fake-input').each(function (i, item) {
                    $(item).hide();
                })
            }
        }

        function checkPlaceValue() {
            if ($('#id_contacts_set-0-place').val() === "")
                modal_button.show();
            else
                modal_button.hide();
        }
        $(".btn-toggle-day").click(function (e) {
            e.preventDefault();
            $(".toggle-days").slideToggle("100").attr('data-id');

        });


        function setCoordsPostion(lat, long) {
            $("#id_contacts_set-0-longitude").val(long);
            $("#id_contacts_set-0-latitude").val(lat);
        }

        function changeValue(key, data, flag) {
            var true_input = $('#true-inputs').find('input#id_contacts_set-0-' + key);
            var true_value = true_input.val().replace(/[^\d.]/g, '');
            if (flag === "from") {
                if ((true_input.val() !== "") && (true_value.length <= 4)) {
                    true_input.val(data + true_input.val());
                }
                else {
                    true_input.val("");
                    true_input.val(data + " - ");
                }
            } else {
                if ((true_input.val() !== "") && (true_value.length <= 4)) {
                    true_input.val(true_input.val() + data);
                } else {
                    true_input.val("");
                    true_input.val(" - " + data);
                }
            }
        }

        var day_key;
        $('.from_time').on('change', function () {
            day_key = $(this).closest('.fake-input').attr('data-key');
            var that = $(this);
            changeValue(day_key, that.val(), "from");
            if (that.closest('.fake-input').hasAttr('data-first')) {
                console.log("hey!");
                $(".from_time").not(that).each(function (i, item) {
                    if (($(item).closest('.fake-input').attr('data-key') !== 'sunday') &&
                        ($(item).closest('.fake-input').find('input.checked_day').hasAttr('checked'))) {
                        $(item).val(that.val());
                        var item_key = $(item).closest('.fake-input').attr('data-key');
                        changeValue(item_key, that.val(), "from")
                    }
                });
            }
        });

        $('.to_time').on('change', function () {
            day_key = $(this).closest('.fake-input').attr('data-key');
            var that = $(this);
            changeValue(day_key, that.val(), "to");
            if (that.closest('.fake-input').hasAttr('data-first')) {
                $(".to_time").not(that).each(function (i, item) {
                    if (($(item).closest('.fake-input').attr('data-key') !== 'sunday') &&
                        ($(item).closest('.fake-input').find('input.checked_day').hasAttr('checked'))) {
                        $(item).val(that.val());
                        var item_key = $(item).closest('.fake-input').attr('data-key');
                        changeValue(item_key, that.val(), "to")
                    }
                });
            }
        });

        $('.checked_day').on('click', function () {
            let parent = $(this).closest('.fake-input');
            var parent_key = parent.attr('data-key');
            if ($(this).hasAttr('checked')) {
                $(this).attr('checked', false);
                parent.find('input.from_time').attr("disabled", true)
                    .val("");
                parent.find('input.to_time').attr("disabled", true)
                    .val("");
                $('#true-inputs').find('input#id_contacts_set-0-' + parent_key).val("");
            } else {
                $(this).attr('checked', true);
                parent.find('input.from_time').attr("disabled", false)
                    .val("");
                parent.find('input.to_time').attr("disabled", false)
                    .val("");
            }
        });


        $('.fake-input').each(function (i, item) {
            var data_key = $(item).attr('data-key');
            var true_value = $('#true-inputs').find('input#id_contacts_set-0-' + data_key).val();
            if (true_value) {
                $(this).find('input.checked_day').attr('checked', 'checked');
                $(item).find('input.from_time').val(true_value.split("-")[0]);
                $(item).find('input.to_time').val(true_value.split("-")[1]);
            }else {
                $(this).find('input.checked_day').attr('checked', false);
                $(item).find('input.from_time').attr("disabled", true);
                $(item).find('input.to_time').attr("disabled", true);
            }
        });

        function init() {
            var myPlacemark,
                myMap = new ymaps.Map('yandex_map', {
                    center: [42.8758, 74.6179],
                    zoom: 10,
                    controls: ['zoomControl', 'typeSelector']
                });
            var searchControl = new ymaps.control.SearchControl({
                options: {
                    float: 'left',
                    floatIndex: 100,
                    noPlacemark: true
                }
            });
            myMap.controls.add(searchControl);
            myMap.behaviors.disable('scrollZoom');
            myPlacemark = createPlacemark(["{{ latitude }}", "{{ longitude  }}"]);
            myMap.geoObjects.add(myPlacemark);
            // Слушаем клик на карте.
            myMap.events.add('click', function (e) {
                var coords = e.get('coords');
                setCoordsPostion(coords[0], coords[1]);
                // Если метка уже создана – просто передвигаем ее.
                if (myPlacemark) {
                    myPlacemark.geometry.setCoordinates(coords);
                }
                // Если нет – создаем.
                else {
                    myPlacemark = createPlacemark(coords);
                    myMap.geoObjects.add(myPlacemark);
                    // Слушаем событие окончания перетаскивания на метке.
                    myPlacemark.events.add('dragend', function () {
                        getAddress(myPlacemark.geometry.getCoordinates());
                        setCoordsPostion(coords[0], coords[1]);
                    });
                }
                getAddress(coords);
            });

            // Создание метки.
            function createPlacemark(coords) {
                return new ymaps.Placemark(coords, {
                    iconCaption: 'поиск...'
                }, {
                    preset: 'islands#violetDotIconWithCaption',
                    draggable: true
                });
            }

            // Определяем адрес по координатам (обратное геокодирование).
            function getAddress(coords) {
                myPlacemark.properties.set('iconCaption', 'поиск...');
                ymaps.geocode(coords).then(function (res) {
                    var firstGeoObject = res.geoObjects.get(0);

                    myPlacemark.properties
                        .set({
                            // Формируем строку с данными об объекте.
                            iconCaption: [
                                // Название населенного пункта или вышестоящее административно-территориальное образование.
                                firstGeoObject.getLocalities().length ? firstGeoObject.getLocalities() : firstGeoObject.getAdministrativeAreas(),
                                // Получаем путь до топонима, если метод вернул null, запрашиваем наименование здания.
                                firstGeoObject.getThoroughfare() || firstGeoObject.getPremise()
                            ].filter(Boolean).join(', '),
                            // В качестве контента балуна задаем строку с адресом объекта.
                            balloonContent: firstGeoObject.getAddressLine()
                        });
                });
            }
        }

        function Switch() {
            $('.switcher').on('change', function () {
                let that = $(this);
                let toggle = $('.toggle-days');
                let parent = that.closest(toggle);
                let weekDays = parent.find('.weekdays');
                if (that.attr('data-visible') === 'true') {
                    $(weekDays).fadeOut('slow');
                    that.attr('data-visible', 'false');
                } else {
                    $(weekDays).fadeIn('slow');
                    that.attr('data-visible', 'true');
                }
            });
            $('.switcher').each(function () {
                let that = $(this);
                let parent = that.closest('.toggle-days');
                let weekDays = parent.find('.weekdays');
                let checked = parent.find('input.switch__input');
                if (checked.attr('checked')) {
                    that.attr('data-visible', 'false');
                    $(weekDays).fadeOut('slow');
                } else {
                    that.attr('data-visible', 'true');
                    $(weekDays).fadeIn('slow');
                }

            });
        }
        Switch();
    </script>
    <script src="{% static 'js/picker.js' %}"></script>
    <script src="{% static 'js/picker.time.js' %}"></script>
    <script>
        $('.timepicker').pickatime({
            format: 'HH:i'
        })
    </script>
{% endblock %}
