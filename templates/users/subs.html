{% load product_tags class_name %}

{% for sub in sub_objects %}

    {% if sub|class_name == "Sales" %}

        <div class="col-md-4" style="height: 350px; background: #fff;">
            <span class="descount">{{ sub.discount }}%</span>
            <div class="img-wrapper">
                <img src="{{ sub.image.url }}" alt="" class="img-responsive">
            </div>
            <div class="description" style="margin-top: 30px;">
                <h3 style="margin-bottom: 10px;">{{ sub.title }}</h3>
                <p style="margin-bottom: 10px;">{{ sub.description }}</p>
                <a class="btn add" style="margin-top: 10px;" href="{% url 'shops:sale_detail' slug=sub.shop.slug pk=sub.pk %}">Просмотреть</a>

            </div>
        </div>

    {% elif sub|class_name == "Product" %}

        <div class="col-md-4 product">
            <div class="box-shadow">

                <div class="img-wrapper">
                    <a href="{{ sub.get_absolute_url }}" class="url-shop"></a>
                    {% if discount %}
                    <span class="descount">{{ sub.discount }}%</span>
                        {% endif %}
                    <a href="{{ sub.get_absolute_url }}">
                        <img src="{{ sub.get_all_images.first.image.url }}" alt="">
                    </a>
                    <div class="back-fade">

                        <div class="name-magazin-title">
                            <h2>
                                <a href="{% url 'shops:detail' slug=sub.shop.slug %}">
                                    {{ sub.shop.title }}
                                </a>
                            </h2>
                            <p>{{ sub.short_description }}</p>
                        </div>

                        <div class="button-basket-favorite">
                        {% cart_message request sub %}

                        </span>

                            <span class="glyphicon glyphicon-heart enable
                            {% is_favorite_for_like sub request.user %}"
                                  data-toggle="tooltip"
                                  data-placement="top"
                                  data-product-id="{{ sub.id }}"
                                  data-original-title="{% is_favorite_for_tooltip sub request.user %}">
                        </span>
                        </div>

                    </div>
                </div>

                <div class="description">

                    <div class="title">
                        <h3>{{ sub.title }}</h3>
                        <p>{{ sub.short_description }}</p>
                    </div>
                    <span>{{ sub.price }} {{ sub.currency }}</span>
                </div>
            </div>

        </div>



    {% endif %}
{% endfor %}
<script>

    if ($('[data-original-title]').length > 0) {
        $('[data-original-title]').tooltip({});
    }
</script>

<script>
    $('.add-basket').click(function (event) {
        event.preventDefault();
        var thisItem = $(this);
        var productId = thisItem.attr("data-product-id");
        $.ajax({
            type: "GET",
            url: "/cart/",
            data: {
                "item": productId
            },
            success: function (data) {
                showFlashMessage(data.flash_message);
                console.log(data);
                console.log(data.total_items);
                $('.cart-count').text(data.total_items);
                if (data.item_added) {
                    thisItem.toggleClass("enable");
                    thisItem.attr('data-original-title', "В корзине");
                }
                else if (data.deleted) {
                    thisItem.removeClass("enable");
                    thisItem.attr('data-original-title', "Добавить в корзину");
                }
            },
            error: function (response, error) {
                console.log(response);
                console.log(error);
            }
        })
    });


    $(".glyphicon-heart").click(function (event) {
        event.preventDefault();
        var thisIcon = $(this);
        var productId = $(this).attr("data-product-id");
        console.log(productId);
        $.ajax({
            type: "GET",
            url: "/favorite/add",
            data: {
                'item': productId
            },
            success: function (data) {
                showFlashMessage(data.flash_message);
                console.log(data);
                if (data.created) {
                    thisIcon.toggleClass("like");
                    thisIcon.attr("data-original-title", "Удалить из избранных");
                }
                else {
                    thisIcon.removeClass("like");
                    thisIcon.attr("data-original-title", "Добавить в избранное");
                    if (thisIcon.parent().parent().parent().parent().parent().parent().hasClass('favorite-products')) {
                        thisIcon.parent().parent().parent().parent().fadeOut();
                    }
                }
                $('.favorites_count').text(data.favorites_count)
            },
            error: function (response, error) {
                console.log(response);
                console.log(error);
            }
        })

    });

    function showFlashMessage(message) {
        var template = "<div class='container container-alert-flash'>" +
            "<div class='col-sm-3 col-sm-offset-8'> " +
            "<div class='alert alert-success alert-dismissible' role='alert'>" +
            "<button type='button' class='close' data-dismiss='alert' aria-label='Close'>" +
            "<span aria-hidden='true'>&times;</span></button>"
            + message + "</div></div></div>";
        $("body").append(template);
        $(".container-alert-flash").fadeIn();
        setTimeout(function () {
            $(".container-alert-flash").fadeOut();
        }, 1800);

    }
</script>
